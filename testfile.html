<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>MC 2017</title>
        <script type="text/javascript" src="d3/d3.v3.min.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    </head>
    <body>
        <h1>MC 2017</h1>
        <p>
            <!--<input id="volume" type="range" min="0" max="397" step="1" value="0"/>-->
            <div id="container">
                <input type="checkbox" name="entrance"> Remove Entrances
                <input type="checkbox" name="camping"> Remove Campsites
                <input type="checkbox" name="general"> Remove General Gates
                <input type="checkbox" name="gate"> Remove Gates
                <input type="checkbox" name="ranger"> Remove Ranger-Stops
            </div>
        </p>
        <p>
            <input type="text" name="daterange" value="05/01/2015 - 05/31/2016" />

            <script>
                $(function() {
                $('input[name="daterange"]').daterangepicker({
                    opens: 'left'
                }, function(start, end, label) {
                    console.log("A new date selection was made: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
                });
                });
            </script>
        </p>
        <p>
            <button onclick="run()">Play</button>
            <button id="stop" onclick="stop()">Stop</button>
        </p>
        <h5 id="day"></h5>
        <script type="text/javascript">     
            
            document.querySelector('#container').onclick = function(ev) {
                if(ev.target.checked){
                    select_els = document.querySelectorAll('[id ^=' + ev.target.getAttribute('name') + ']');
                    console.log(select_els);
                    for (let i = 0; i < select_els.length; i++) {
                        select_els[i].style.display = "none";
                    }
                }
                else{
                    select_els = document.querySelectorAll('[id ^=' + ev.target.getAttribute('name') + ']');
                    for(let i = 0; i < select_els.length; i++){
                        select_els[i].style.display = "block";
                    }
                }
            }




            /*document.getElementById('volume').addEventListener('change', function() {

            var curr_volume = this.value;

            console.log("curr_volume ", curr_volume);

            // now do something with curr_volume
            });
            */

           function run(){
                if(!document.getElementById("map")){
                var w = 600;
                var h = 600;
                var padding = 6;

                //Dynamic, random dataset
                var dataset = [];					//Initialize empty array
                var numDataPoints = 40;				//Number of dummy data points to create
                var xRange = 600;	//Max range of new x values
                var yRange = 600;	//Max range of new y values

                d3.csv("Checkpoints.csv", function(data) { 
                    checkpoints_done(data);
                });

                function checkpoints_done(checkpoints){
                    d3.csv("dump.csv", function(data) { 
                        data_ready(checkpoints, data);
                    });
                }

                function data_ready(checkpoints, dataset){
                    //Create scale functions
                    var xScale = d3.scale.linear()
                                        .domain([0, 600])
                                        .range([padding, w - padding]);

                    var yScale = d3.scale.linear()
                                        .domain([0, 600])
                                        .range([h - padding, padding]);

                    var sizeScale = d3.scale.linear()
                                        .domain([0, 600])
                                        .range([300,500]);

                    
                    //Define X axis
                    var xAxis = d3.svg.axis()
                                    .scale(xScale)
                                    .orient("bottom")
                                    .ticks(5);

                    //Define Y axis
                    var yAxis = d3.svg.axis()
                                    .scale(yScale)
                                    .orient("left")
                                    .ticks(5);

                    
                    //Create SVG element
                    var svg = d3.select("body")
                                .append("svg")
                                .attr("id", "map")
                                .attr("width", w)
                                .attr("height", h)
                                .style("background", "url(DumpPath.png)");
                    
                    d3.select("#stop").on("click",function(){
                        console.log("Here");
                        svg.selectAll(".circle").interrupt();
                    });
                
                    var dataset1 = [];					//Initialize empty array
                    /*for(i=0; i < dataset.length/2; i++){
                        console.log(dataset[i]);
                        dataset1.push(dataset[i]);	
                    }
                    var dataset2 = [];					//Initialize empty array
                    for(i=dataset.length/2; i < dataset.length; i++){
                        dataset2.push(dataset[i]);
                    }
                    */

                    /*
                        All objects with size 
                        greater than the average size of all scatterplot 
                        objects should be colored blue and all other objects 
                        should be colored green. 
                    */
                    var totalSize = 0;
                    var averageSize = 0;
                    var count = 0;
                    var currSize = 0;

                    svg.selectAll("circle")
                        .data(dataset)
                        .enter()
                        .append("path")
                        .attr("cx", d => xScale(d["X"]))
                        .attr("cy", d => yScale(parseFloat(d["Y"])))
                        .attr("d", d => { 
                            currSize = Math.round(/*sizeScale(d["X"]*/100);
                            totalSize = totalSize + currSize;
                            //ataset[count++].push(currSize);
                            averageSize = totalSize / count; 
                            return d3.svg.symbol().type("circle").size(currSize)(d)})
                        .attr("transform", d => "translate(" + xScale(d["X"]) + "," 
                            + yScale(parseFloat(d["Y"])) + ")")
                        .attr("fill", "green")
                        .attr("class", "circle")
                        .attr("id", d => d["Location"])
                        .attr("stroke", d=> { return d[2] > averageSize ? "blue" : "green"});

                    numDays = 397;
                    function update(day){
                        svg.selectAll(".circle")
                        .transition()
                        .duration(300)
                        .attr("d", d => {
                            document.getElementById("day").innerText = "Day: " + day;
                            return d3.svg.symbol().type("circle").size(getSize(checkpoints, day, d["Location"]))(d);
                        })
                    }

                    for(var i = 0; i < numDays; i++){
                        setTimeout(update.bind(null, i), 30*i);
                    }

                    function getSize(checkpoints, day, location){
                        return 100*parseInt(checkpoints[day][location]);
                    }


                    //https://stackoverflow.com/questions/56045182/how-can-i-add-a-delay-between-function-calls-that-change-data-in-d3-js
                    
                    /*svg.selectAll("triangle")
                        .data(dataset)
                        .enter()
                        .append("path")
                        .attr("x", d => xScale(d[0]))
                        .attr("y", d => yScale(parseFloat(d[1])))
                        .attr("d", d => { 
                            currSize = Math.round(sizeScale(d[0]));
                            totalSize = totalSize + currSize;
                            dataset[count++].push(currSize);
                            averageSize = totalSize / count; 
                            return d3.svg.symbol().type("triangle-up").size(currSize)(d)})
                        .attr("transform", d => "translate(" + xScale(d[0]) + "," 
                            + yScale(parseFloat(d[1])) + ")")
                        .attr("fill", "none")
                        .attr("stroke", d=> { return d[2] > averageSize ? "blue" : "green"});
                    */
                    //Create X axis
                    

                    svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(0," + (h - padding) + ")")
                        .call(xAxis)
                    
                    //Create Y axis
                    svg.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(" + padding + ",0)")
                        .call(yAxis);
                        
                    }
                }
            }

            /*
			for (var i = 0; i < numDataPoints; i++) {					//Loop numDataPoints times
				var newNumber1 = Math.round(Math.random() * xRange);	//New random integer
				var newNumber2 = Math.round(Math.random() * yRange);	//New random integer
				dataset.push([newNumber1, newNumber2]);					//Add new number to array
			}
            */
        </script>
    </body>
</html>     
